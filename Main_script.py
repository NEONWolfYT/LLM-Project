from langchain_core.messages import HumanMessage, SystemMessage, AIMessage #pip install langchain_core     ()     pip install langchain_gigachat
from langchain_gigachat.chat_models import GigaChat #pip install GigaChat
from telegram import Update #pip install telegram
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,  # Добавляем этот импорт
)
giga = GigaChat(
    credentials="MTVhNjY3NTMtZmI1MS00NTUyLTliNjctODAwMWI2ZDczZGI3OmFmZWFkYTg4LWI2NDMtNGE2Zi1iOTgwLWI2YTJmMTBlNDY3Ng==",verify_ssl_certs=False,
)

messages = [
    SystemMessage(content="Необходимо извлечь определенные технические характеристики из описания продукта и представить их в четко определенном формате. Отсутствующие данные следует отмечать как \"Неизвестно\".\n\n#### Входные данные\nОписание продукта:  \n`IP-камера TRASHPIR TR-D2223W, промышленная`\n\n#### Категории характеристик\n- Вид продукции\n- Производитель\n- Модель\n- Тип\n- Разрешение\n- Угол обзора\n- ИК-подсветка\n\n#### Формат вывода\nИспользовать следующий шаблон для каждого параметра:\n```\nКатегория: Значение\n```\n\nЕсли значение неизвестно, использовать метку `Неизвестно`.\n\n#### Пример\n```markdown\nВид продукции: IP-камера\nПроизводитель: TRASHPIR\nМодель: TR-D2223W\nТип: промышленная\nРазрешение: Неизвестно\nУгол обзора: Неизвестно\nИК-подсветка: Неизвестно\n```\n\n#### Примечания\n1. Используйте точные названия и модели, как указано в описании.\n2. Не включайте дополнительную информацию, если её нет в исходном тексте.\n3.Если ты не можешь ответить на запрос пользователя всегда пиши 'Попробуйте другой товар'"),
    HumanMessage(content="IP-камера TRASPIIR TR-D32565413 v 2 2.8, ударопрочная"),AIMessage(content="Вид продукции - IP-камера; Производитель - TRASPIIR; Модель - TR-D32565413 v 2 2.8; Тип - ударопрочная; Разрешение - Неизвестно; Угол обзора - Неизвестно; ИК-подсветка - Неизвестно."),
    HumanMessage(content="Авиакеросин Т-1"),AIMessage(content="Вид продукции - Авиакеросин; Марка - Т-1; Объем - Неизвестно; ГОСТ - Неизвестно; Сорт - Неизвестно; Упаковка - Неизвестно."),
    HumanMessage(content="IP-камера TRASHPIR TR-D2223W, промышленная"),AIMessage(content="Вид продукции - IP-камера; Производитель - TRASHPIR; Модель - TR-D2223W; Тип - промышленная; Разрешение - Неизвестно; Угол обзора - Неизвестно; ИК-подсветка - Неизвестно."),
    HumanMessage(content="IP-камера TRASPIIR TR-D32565413 v 2 2.8, ударопрочная"),AIMessage(content="Вид продукции - IP-камера; Производитель - TRASPIIR; Модель - TR-D32565413 v 2 2.8; Тип - ударопрочная; Разрешение - Неизвестно; Угол обзора - Неизвестно; ИК-подсветка - Неизвестно."),
    HumanMessage(content="Авиакеросин Т-1"),AIMessage(content="Вид продукции - Авиакеросин; Марка - Т-1; Объем - Неизвестно; ГОСТ - Неизвестно; Сорт - Неизвестно; Упаковка - Неизвестно."),
    HumanMessage(content="Автокамера 11.00-20/11.00"),AIMessage(content="Вид продукции - Автокамера; Размер - 11.00-20/11.00; Тип - Неизвестно; Производитель - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Автошина 11,00R24"),AIMessage(content="Вид продукции - Автошина; Размер - 11,00R24; Модель - Неизвестно; Индекс нагрузки - Неизвестно; Индекс скорости - Неизвестно."),
    HumanMessage(content="Автошина 11,00R20 И-121АМ"),AIMessage(content="Вид продукции - Автошина; Размер - 11,00R20; Модель - И-121АМ; Индекс нагрузки - Неизвестно; Индекс скорости - Неизвестно."),
    HumanMessage(content="Автошина 420х85R21-146J Кама-1460"),AIMessage(content="Вид продукции - Автошина; Размер - 420х85R21; Индекс нагрузки - 146; Индекс скорости - J; Модель - Кама-1460."),
    HumanMessage(content="Автошина 9,25R22 240/508 У-2 (ПАЗ-53) У-2 Нс12"),AIMessage(content="Вид продукции - Автошина; Размер - 9,25R22; Индекс нагрузки - 240/508; Модель - У-2 (ПАЗ-53) У-2 Нс12."),
    HumanMessage(content="Автошина Dunlop Grarek AT22 285/60R18 116V"),AIMessage(content="Вид продукции - Автошина; Производитель - Dunlop; Модель - Grarek AT22; Размер - 285/60R18; Индекс нагрузки - 116; Индекс скорости - V."),
    HumanMessage(content="Аккумулятор Tumen 11В 2,2А/час герметичный свинцово-кислотный"),AIMessage(content="Вид продукции - Аккумулятор; Производитель - Tumen; Напряжение - 11В; Емкость - 2,2А/час; Тип - герметичный свинцово-кислотный."),
    HumanMessage(content="Аккумулятор Tumen 11В 26А/ч герметичный свинцово-кислотный"),AIMessage(content="Вид продукции - Аккумулятор; Производитель - Tumen; Напряжение - 11В; Емкость - 26А/ч; Тип - герметичный свинцово-кислотный."),
    HumanMessage(content="Аккумулятор Tumen 12В 26А/ч герметичный свинцово-кислотн."),AIMessage(content="Вид продукции - Аккумулятор; Производитель - Tumen; Напряжение - 12В; Емкость - 26А/ч; Тип - герметичный свинцово-кислотный."),
    HumanMessage(content="Агрегат насосный 12,5/100.3450 151"),AIMessage(content="Вид продукции - Агрегат насосный; Модель - 12,5/100.3450 151; Производительность - Неизвестно; Напор - Неизвестно; Мощность - Неизвестно."),
    HumanMessage(content="Агрегат насосный НК 210/"),AIMessage(content="Вид продукции - Агрегат насосный; Модель - НК 210/; Производительность - Неизвестно; Напор - Неизвестно; Мощность - Неизвестно."),
    HumanMessage(content="Адаптер 'ниппель-фланец' тип 200-AL-SS 2 DN50 PN16"),AIMessage(content="Вид продукции - Адаптер; Тип - ниппель-фланец; Модель - 200-AL-SS 2; Диаметр - DN50; Давление - PN16."),
    HumanMessage(content="Азот ВЧ (99,999%)"),AIMessage(content="Вид продукции - Азот; Тип - ВЧ (99,999%); Объем - Неизвестно; Упаковка - Неизвестно; ГОСТ - Неизвестно."),
    HumanMessage(content="Азот газообразный 4,7 куб.м. ГОСТ 9293-74 2 сорт."),AIMessage(content="Вид продукции - Азот газообразный; Объем - 4,7 куб.м.; ГОСТ - 9293-74; Сорт - 2; Упаковка - Неизвестно."),
    HumanMessage(content="Амортизатор 53212"),AIMessage(content="Вид продукции - Амортизатор; Модель - 53212; Применение - Неизвестно; Производитель - Неизвестно."),
    HumanMessage(content="Амортизатор 630300-1001029"),AIMessage(content="Вид продукции - Амортизатор; Модель - 630300-1001029; Применение - Неизвестно; Производитель - Неизвестно."),
    HumanMessage(content="Амортизатор ГАЗ-33081, Алтай задней подвески /3308-2915006/"),AIMessage(content="Вид продукции - Амортизатор; Модель - ГАЗ-33081, Алтай; Применение - задней подвески; Артикул - 3308-2915006."),
    HumanMessage(content="Антифриз G-12/-40, 3 литра"),AIMessage(content="Вид продукции - Антифриз; Модель - G-12; Температура - -40°C; Объем - 3 литра; Цвет - Неизвестно."),
    HumanMessage(content="Антифриз LUKOIL G11-40 RED /216.5 л."),AIMessage(content="Вид продукции - Антифриз; Производитель - LUKOIL; Модель - G11-40 RED; Объем - 216.5 л; Цвет - красный."),
    HumanMessage(content="Антифриз SAKURA RED"),AIMessage(content="Вид продукции - Антифриз; Производитель - SAKURA; Цвет - RED; Объем - Неизвестно; Температура - Неизвестно."),
    HumanMessage(content="Аппарат для нагрева и охлаждения воды 110111501 HotFrost D115"),AIMessage(content="Вид продукции - Аппарат для нагрева воды; Модель - HotFrost D115; Артикул - 110111501; Мощность - Неизвестно."),
    HumanMessage(content="Аппарат электромагнитный пускорегулирующий ПРА IP20 УХЛ2"),AIMessage(content="Вид продукции - Аппарат пускорегулирующий; Тип - ПРА; Защита - IP20; Исполнение - УХЛ2; Мощность - Неизвестно."),
    HumanMessage(content="Аппарат электромагнит/ пускорегулирующий УХЛ1"),AIMessage(content="Вид продукции - Аппарат пускорегулирующий; Тип - электромагнитный; Исполнение - УХЛ1; Мощность - Неизвестно."),
    HumanMessage(content="Балансир УАЗ"),AIMessage(content="Вид продукции - Балансир; Применение - УАЗ; Модель - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Балансир ГАЗ 71-2946011-10"),AIMessage(content="Вид продукции - Балансир; Применение - ГАЗ; Модель - 71-2946011-10; Материал - Неизвестно."),
    HumanMessage(content="Балансир первого катка 71-2946010-10"),AIMessage(content="Вид продукции - Балансир; Применение - первого катка; Модель - 71-2946010-10; Материал - Неизвестно."),
    HumanMessage(content="Балансир ГАЗ 34040"),AIMessage(content="Вид продукции - Балансир; Применение - ГАЗ 34040; Модель - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Балансир правый передний"),AIMessage(content="Вид продукции - Балансир; Позиция - правый передний; Модель - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Балансир среднего катка 71-2946012"),AIMessage(content="Вид продукции - Балансир; Применение - среднего катка; Модель - 71-2946012; Материал - Неизвестно."),
    HumanMessage(content="Балка Б35-2-16 с.3.407.9-146 С345"),AIMessage(content="Вид продукции - Балка; Модель - Б35-2-16; Артикул - с.3.407.9-146; Материал - С345."),
    HumanMessage(content="Бензин Регуляр-92 (П) (АИ-92-К5) (литр)"),AIMessage(content="Вид продукции - Бензин; Марка - Регуляр-92 (П); Октановое число - АИ-92; Стандарт - К5; Единица - литр."),
    HumanMessage(content="Бензиновая фракция"),AIMessage(content="Вид продукции - Бензиновая фракция; Состав - Неизвестно; Плотность - Неизвестно; Применение - Неизвестно."),
    HumanMessage(content="Бензобак Уаз-452 основной УМЗ-4213 /220694-1101008-01/"),AIMessage(content="Вид продукции - Бензобак; Применение - Уаз-452 основной; Модель двигателя - УМЗ-4213; Артикул - 220694-1101008-01."),
    HumanMessage(content="Бензонасос Газ 3302; 3110 дв. 406 эл (хомут) ВОSСН; арт. 0580464038"),AIMessage(content="Вид продукции - Бензонасос; Применение - Газ 3302, 3110; Двигатель - 406; Тип - эл (хомут); Производитель - ВОSСН."),
    HumanMessage(content="Бензопила MAKITA MS 211 шина 20 см"),AIMessage(content="Вид продукции - Бензопила; Производитель - MAKITA; Модель - MS 211; Длина шины - 20 см; Мощность - Неизвестно."),
    HumanMessage(content="Втулка цилиндровая ф120"),AIMessage(content="Вид продукции - Втулка; Тип - цилиндровая; Диаметр - ф120; Материал - Неизвестно."),
    HumanMessage(content="Втулка цилиндровая ф-135"),AIMessage(content="Вид продукции - Втулка; Тип - цилиндровая; Диаметр - ф-135; Материал - Неизвестно."),
    HumanMessage(content="Втулка шаровой опоры"),AIMessage(content="Вид продукции - Втулка; Тип - шаровой опоры; Диаметр - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Выключатель автоматический IEC 1P 6 KA C-1 A 1M, MC101A"),AIMessage(content="Вид продукции - Выключатель автоматический; Стандарт - IEC; Полюсность - 1P; Отключающая способность - 6 кА; Характеристика - C; Ток - 1A."),
    HumanMessage(content="Гайка штока НПЦ 02.007 ЦА"),AIMessage(content="Вид продукции - Гайка; Тип - штока; Производитель - НПЦ; Модель - 02.007; Материал - ЦА."),
    HumanMessage(content="Гайковерт аккумуляторный, ударный Makita DTGFIW1900RME"),AIMessage(content="Вид продукции - Гайковерт; Тип - аккумуляторный ударный; Производитель - Makita; Модель - DTGFIW1900RME."),
    HumanMessage(content="Гайковерт аккумуляторный, Makita DTW190RME"),AIMessage(content="Вид продукции - Гайковерт; Тип - аккумуляторный; Производитель - Makita; Модель - DTGFIW1900RME."),
    HumanMessage(content="Гайковерт аккумуляторный Makita DTW190RME"),AIMessage(content="Вид продукции - Гайковерт; Тип - аккумуляторный; Производитель - Makita; Модель - DTGFIW1900RME."),
    HumanMessage(content="Гарнитура Logitech H110 Stereo"),AIMessage(content="Вид продукции - Гарнитура; Тип - Stereo; Производитель - Logitech; Модель - H110."),
    HumanMessage(content="Блок питания / Cisco AC Power 1025745841, 12 V"),AIMessage(content="Вид продукции - Блок питания; Производитель - Cisco; Тип - AC Power; Артикул - 1025745841; Напряжение - 12V."),
    HumanMessage(content="Блок предохранительных клапановГАЗ66"),AIMessage(content="Вид продукции - Блок предохранительных клапанов; Применение - ГАЗ66; Модель - Неизвестно."),
    HumanMessage(content="Блок шестеренок ГАЗ-53 с/о"),AIMessage(content="Вид продукции - Блок шестеренок; Применение - ГАЗ-53; Тип - с/о; Материал - Неизвестно."),
    HumanMessage(content="Блоки розеток Sheider 7240.260 19U"),AIMessage(content="Вид продукции - Блок розеток; Производитель - Sheider; Модель - 7240.260; Размер - 19U."),
    HumanMessage(content="Болт c полной резьбой ГОСТ 7798 M16x35"),AIMessage(content="Вид продукции - Болт; Тип - с полной резьбой; Стандарт - ГОСТ 7798; Размер - M16x35."),
    HumanMessage(content="Болт колеса L-80 мм М22х1,5 54321 3104051"),AIMessage(content="Вид продукции - Болт; Тип - колесный; Размер - L-80 мм М22х1,5; Артикул - 54321 3104051."),
    HumanMessage(content="Болт М14х1,5х75"),AIMessage(content="Вид продукции - Болт; Размер - М14х1,5х75; Тип - Неизвестно; Материал - Неизвестно."),
    HumanMessage(content="Болторез 900 мм"),AIMessage(content="Вид продукции - Болторез; Длина - 900 мм; Тип - Неизвестно; Производитель - Неизвестно."),
    HumanMessage(content="Ботинки кожаные Franchesco, р.35"),AIMessage(content="Вид продукции - Ботинки; Производитель - Franchesco; Размер - 35; Материал - кожаные."),
    HumanMessage(content="Болт 12х110 ХЛ ГОСТ 28778-90"),AIMessage(content="Вид продукции - Болт; Тип - БСР; Размер - 12х110; Стандарт - ГОСТ 28778-90; Исполнение - УХЛ."),
    HumanMessage(content="Болт карданный 2217-2200154545465"),AIMessage(content="Вид продукции - Болт; Тип - карданный; Артикул - 2217-2200154545465; Применение - Неизвестно."),
    HumanMessage(content="Боты диэлектрические ТУ 38 106645465564-96"),AIMessage(content="Вид продукции - Боты; Тип - диэлектрические; Стандарт - ТУ 38 106645465564-96."),
    HumanMessage(content="Брызговик ГАЗ 3163-8546320-00"),AIMessage(content="Вид продукции - Брызговик; Применение - ГАЗ 3163; Артикул - 3163-8546320-00."),
    HumanMessage(content="Болт БСР 12х110 УХЛ ГОСТ 28778-90"),AIMessage(content="Вид продукции - Болт; Тип - БСР; Размер - 12х110; Стандарт - ГОСТ 28778-90; Исполнение - УХЛ.")
]

# Токен вашего бота (замените на ваш)
TOKEN = '7628159249:AAEDsV074bBcSWqzjWcu7bmI6oWpDmwRGIA'

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Очищаем историю сообщений при старте"""
    context.user_data['messages'] = []
    await update.message.reply_text(
        "Привет! Я бот с искусственным интеллектом. Напиши мне что-нибудь.\n"
        "Чтобы закончить диалог, напиши 'стоп'."
    )


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_text = update.message.text

    # Инициализируем историю сообщений, если её нет
    if 'messages' not in context.user_data:
        context.user_data['messages'] = []

    # Проверяем команду на остановку
    if user_text.lower() == "стоп":
        await update.message.reply_text("Диалог завершён. Напишите /start для нового диалога.")
        context.user_data['messages'] = []
        return

    # Добавляем сообщение пользователя в историю
    messages.append(HumanMessage(content=user_text))

    try:
        # Получаем ответ от модели
        res = giga.invoke(messages)
        
        # Добавляем ответ модели в историю
        messages.append(res)
        
        # Сохраняем обновленную историю
        context.user_data['messages'] = messages
        
        # Отправляем ответ пользователю
        await update.message.reply_text(res.content)
        
    except Exception as e:
        await update.message.reply_text(f"Ошибка: {str(e)}")
        context.user_data['messages'] = []  # Сбрасываем историю при ошибке


def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    app.run_polling()

if __name__ == "__main__":
    main()


